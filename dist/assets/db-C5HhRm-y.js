import{A as a}from"./config-BpQc0ceR.js";const h={DB_NAME:a.DB_NAME,DB_VERSION:a.DB_VERSION,STORE_NAME:"words",META_STORE:"meta",NOTES_STORE:"notes",TRAINING_STORE:"training",db:null,isReady:!1,async init(){return this.db?!0:new Promise((t,s)=>{const o=indexedDB.open(this.DB_NAME,this.DB_VERSION);o.onerror=e=>{console.error("[DB] Error opening database:",e.target.error),s(e.target.error)},o.onsuccess=e=>{this.db=e.target.result,this.isReady=!0,console.log("[DB] Database opened successfully"),t(!0)},o.onupgradeneeded=e=>{const r=e.target.result;if(!r.objectStoreNames.contains(this.STORE_NAME)){const n=r.createObjectStore(this.STORE_NAME,{keyPath:"id"});n.createIndex("swedish","swe",{unique:!1}),n.createIndex("arabic","arb",{unique:!1}),n.createIndex("type","type",{unique:!1}),console.log("[DB] Words store created")}r.objectStoreNames.contains(this.META_STORE)||(r.createObjectStore(this.META_STORE,{keyPath:"key"}),console.log("[DB] Meta store created")),r.objectStoreNames.contains(this.NOTES_STORE)||(r.createObjectStore(this.NOTES_STORE,{keyPath:"id"}),console.log("[DB] Notes store created")),r.objectStoreNames.contains(this.TRAINING_STORE)||(r.createObjectStore(this.TRAINING_STORE,{keyPath:"id"}),console.log("[DB] Training store created"))}})},async getDataVersion(){return this.db||await this.init(),this.db?new Promise(t=>{try{const e=this.db.transaction([this.META_STORE],"readonly").objectStore(this.META_STORE).get("dataVersion");e.onsuccess=()=>{var r;t(((r=e.result)==null?void 0:r.value)||null)},e.onerror=()=>t(null)}catch{t(null)}}):null},async setDataVersion(t){return this.db||await this.init(),this.db?new Promise((s,o)=>{const e=this.db.transaction([this.META_STORE],"readwrite");e.objectStore(this.META_STORE).put({key:"dataVersion",value:t}),e.oncomplete=()=>s(!0),e.onerror=n=>o(n)}):!1},async getWordCount(){return this.db||await this.init(),this.db?new Promise(t=>{try{const e=this.db.transaction([this.STORE_NAME],"readonly").objectStore(this.STORE_NAME).count();e.onsuccess=()=>t(e.result),e.onerror=()=>t(0)}catch{t(0)}}):0},async saveWords(t,s=null){this.db||await this.init();const o=1e3,e=Math.ceil(t.length/o);console.log(`[DB] Saving ${t.length} words in ${e} batches...`);for(let r=0;r<e;r++){const n=r*o,i=Math.min(n+o,t.length),c=t.slice(n,i);if(await this._saveBatch(c),s){const d=Math.round((r+1)/e*100);s(d)}}return console.log("[DB] All words saved successfully"),!0},async _saveBatch(t){return this.db?new Promise((s,o)=>{const e=this.db.transaction([this.STORE_NAME],"readwrite"),r=e.objectStore(this.STORE_NAME);t.forEach(n=>{const i={id:n[a.COLUMNS.ID],type:n[a.COLUMNS.TYPE],swe:n[a.COLUMNS.SWEDISH],arb:n[a.COLUMNS.ARABIC],arbExt:n[a.COLUMNS.ARABIC_EXT],sweDef:n[a.COLUMNS.DEFINITION],forms:n[a.COLUMNS.FORMS],sweEx:n[a.COLUMNS.EXAMPLE_SWE],arbEx:n[a.COLUMNS.EXAMPLE_ARB],idiomSwe:n[a.COLUMNS.IDIOM_SWE],idiomArb:n[a.COLUMNS.IDIOM_ARB],raw:n};r.put(i)}),e.oncomplete=()=>s(!0),e.onerror=n=>o(n)}):!1},async getAllWords(t=null){return this.db||await this.init(),this.db?new Promise((s,o)=>{const n=this.db.transaction([this.STORE_NAME],"readonly").objectStore(this.STORE_NAME).getAll();n.onsuccess=()=>{const i=n.result.map(c=>c.raw);t&&t(100),console.log(`[DB] Retrieved ${i.length} words from cache`),s(i)},n.onerror=i=>{console.error("[DB] Error getting words:",i),o(i)}}):[]},async hasCachedData(){return await this.getWordCount()>0},async clearCache(){return this.db||await this.init(),this.db?new Promise((t,s)=>{const o=this.db.transaction([this.STORE_NAME,this.META_STORE],"readwrite");o.objectStore(this.STORE_NAME).clear(),o.objectStore(this.META_STORE).clear(),o.oncomplete=()=>{console.log("[DB] Cache cleared"),t(!0)},o.onerror=e=>s(e)}):!1},async getWordById(t){return this.db||await this.init(),this.db?new Promise(s=>{try{const r=this.db.transaction([this.STORE_NAME],"readonly").objectStore(this.STORE_NAME).get(t);r.onsuccess=()=>{r.result&&r.result.raw?s(r.result.raw):s(null)},r.onerror=()=>s(null)}catch(o){console.error("[DB] getWordById error:",o),s(null)}}):null},async getRandomWord(){return this.db||await this.init(),this.db?new Promise(async t=>{try{const s=await this.getWordCount();if(s===0){t(null);return}const o=Math.floor(Math.random()*s),n=this.db.transaction([this.STORE_NAME],"readonly").objectStore(this.STORE_NAME).openCursor();let i=!1;n.onsuccess=c=>{const d=c.target.result;if(!d){t(null);return}!i&&o>0?(i=!0,d.advance(o)):t(d.value.raw||d.value)},n.onerror=()=>t(null)}catch(s){console.error("[DB] getRandomWord error:",s),t(null)}}):null},async saveWord(t){return this.db||await this.init(),this.db?new Promise((s,o)=>{const e=this.db.transaction([this.STORE_NAME],"readwrite");e.objectStore(this.STORE_NAME).put(t),e.oncomplete=()=>s(!0),e.onerror=n=>o(n)}):!1},async deleteWord(t){return this.db||await this.init(),this.db?new Promise((s,o)=>{const e=this.db.transaction([this.STORE_NAME],"readwrite");e.objectStore(this.STORE_NAME).delete(t),e.oncomplete=()=>s(!0),e.onerror=n=>o(n)}):!1},async getNote(t){return this.db||await this.init(),this.db?new Promise(s=>{try{const r=this.db.transaction([this.NOTES_STORE],"readonly").objectStore(this.NOTES_STORE).get(t);r.onsuccess=()=>{var n;s(((n=r.result)==null?void 0:n.text)||null)},r.onerror=()=>s(null)}catch{s(null)}}):null},async saveNote(t,s){return this.db||await this.init(),this.db?new Promise((o,e)=>{const r=this.db.transaction([this.NOTES_STORE],"readwrite");r.objectStore(this.NOTES_STORE).put({id:t,text:s,updatedAt:Date.now()}),r.oncomplete=()=>o(!0),r.onerror=i=>e(i)}):!1},async updateTrainingStatus(t,s){if(this.db||await this.init(),!!this.db)return new Promise((o,e)=>{const r=this.db.transaction([this.TRAINING_STORE],"readwrite"),n=r.objectStore(this.TRAINING_STORE);s?n.put({id:t,addedAt:Date.now()}):n.delete(t),r.oncomplete=()=>{console.log(`[DB] Training status updated for ${t}: ${s}`),o()},r.onerror=i=>e(i)})},async ensureCustomWord(t){if(this.db||await this.init(),!!this.db)return new Promise((s,o)=>{const e=this.db.transaction([this.STORE_NAME],"readwrite"),r=e.objectStore(this.STORE_NAME),n=r.get(t.id);n.onsuccess=()=>{n.result||(r.put(t),console.log(`[DB] Custom word ${t.id} created`))},e.oncomplete=()=>s(),e.onerror=i=>o(i)})},async getTrainingWords(){return this.db||await this.init(),this.db?new Promise((t,s)=>{const o=this.db.transaction([this.TRAINING_STORE,this.STORE_NAME],"readonly"),e=o.objectStore(this.TRAINING_STORE),r=o.objectStore(this.STORE_NAME),n=e.getAll();n.onsuccess=async()=>{const i=n.result;if(i.length===0){console.log("[DB] Found 0 words for training"),t([]);return}const c=[];let d=0;for(const u of i){const l=r.get(u.id);l.onsuccess=()=>{l.result?c.push(l.result.raw||l.result):c.push({id:u.id}),d++,d===i.length&&(console.log(`[DB] Found ${c.length} words for training`),t(c))},l.onerror=()=>{d++,d===i.length&&(console.log(`[DB] Found ${c.length} words for training`),t(c))}}},n.onerror=i=>s(i)}):[]},async isWordMarkedForTraining(t){return this.db||await this.init(),this.db?new Promise(s=>{const r=this.db.transaction([this.TRAINING_STORE],"readonly").objectStore(this.TRAINING_STORE).get(t);r.onsuccess=()=>{s(!!r.result)},r.onerror=()=>s(!1)}):!1}},E={async loadDictionary(t=null,s=null){try{await h.init();const o=await h.getDataVersion();if(await h.hasCachedData()&&o===a.DATA_VERSION)return s&&s("Laddar från cache... / جاري التحميل من الذاكرة..."),console.log("[DataLoader] Using cached data (version:",o,")"),await h.getAllWords(t);s&&s("Laddar ordbok... / جاري تحميل القاموس..."),console.log("[DataLoader] Loading fresh data from data.js");const r=window.dictionaryData;if(typeof r>"u"||!r.length)throw new Error("dictionaryData not loaded from data.js");return s&&s("Sparar i cache... / جاري الحفظ..."),await h.saveWords(r,t),await h.setDataVersion(a.DATA_VERSION),console.log("[DataLoader] Data cached successfully"),r}catch(o){console.error("[DataLoader] Error:",o);const e=window.dictionaryData;if(typeof e<"u")return e;throw o}},async refreshCache(t=null){return await h.clearCache(),this.loadDictionary(t)}};typeof window<"u"&&(window.DictionaryDB=h,window.DataLoader=E,window.DATA_VERSION=a.DATA_VERSION);export{E as DataLoader,h as DictionaryDB};
