const f={activeAudio:null,activeContext:null,cleanupQueue:new Set,cleanup(){if(this.activeAudio){try{this.activeAudio.pause(),this.activeAudio.src="",this.activeAudio.load()}catch{}this.activeAudio=null}this.activeContext&&this.activeContext.state!=="closed"&&(this.activeContext.close().catch(()=>{}),this.activeContext=null),this.cleanupQueue.forEach(e=>{try{e.pause(),e.src=""}catch{}}),this.cleanupQueue.clear()},play(e){return this.cleanup(),this.activeAudio=e,e.play()},createAudio(e){this.cleanup();const t=new Audio(e);return this.activeAudio=t,t},track(e){this.cleanupQueue.add(e)},getAudioContext(){if(this.activeContext&&this.activeContext.state!=="closed")return this.activeContext;const e=window.AudioContext||window.webkitAudioContext;return this.activeContext=new e,this.activeContext},stopAll(){this.cleanup(),window.speechSynthesis&&window.speechSynthesis.cancel()}};typeof window<"u"&&(window.AudioManager=f,window.addEventListener("beforeunload",()=>{f.cleanup()}),document.addEventListener("visibilitychange",()=>{document.hidden&&f.stopAll()}));const w={audio:null,lastSpokenText:"",cachedSwedishVoice:null,cachedVoices:{},audioUnlocked:!1,timeoutId:null,isPlaying:!1,audioCache:new Map,isIOS:/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1,isSafari:/^((?!chrome|android).)*safari/i.test(navigator.userAgent),isAndroid:/Android/i.test(navigator.userAgent),config:{defaultLang:"sv-SE",fallbackLang:"en-US",maxCacheSize:50,timeoutMs:3500,retryAttempts:2},init(){console.log("ğŸ”Š TTSManager initializing...",{isIOS:this.isIOS,isSafari:this.isSafari,isAndroid:this.isAndroid}),this._loadVoices(),window.speechSynthesis&&(window.speechSynthesis.onvoiceschanged=()=>{this._loadVoices()});const e=()=>{this.unlockAudio(),document.removeEventListener("touchstart",e),document.removeEventListener("click",e)};document.addEventListener("touchstart",e,{passive:!0}),document.addEventListener("click",e,{passive:!0}),console.log("ğŸ”Š TTSManager initialized successfully")},_loadVoices(){if(!window.speechSynthesis)return;const e=window.speechSynthesis.getVoices();e.length&&(this.cachedVoices={},e.forEach(t=>{const i=t.lang.substring(0,2);this.cachedVoices[i]||(this.cachedVoices[i]=[]),this.cachedVoices[i].push(t)}),this.cachedSwedishVoice=this._findBestVoice("sv"))},getSpeed(){const e=localStorage.getItem("ttsSpeed");return e?parseFloat(e):.85},setSpeed(e){const t=Math.min(1.5,Math.max(.5,e));return localStorage.setItem("ttsSpeed",t.toString()),t},unlockAudio(){if(!this.audioUnlocked){try{const e=new Audio;e.src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA",e.volume=.01,e.play().then(()=>e.pause()).catch(()=>{})}catch{}try{const e=window.AudioContext||window.webkitAudioContext,t=new e;if(t.state==="suspended")t.resume().then(()=>{const i=t.createOscillator(),s=t.createGain();s.gain.value=0,i.connect(s),s.connect(t.destination),i.start(0),i.stop(.001),setTimeout(()=>t.close(),100)}).catch(()=>{});else{const i=t.createOscillator(),s=t.createGain();s.gain.value=0,i.connect(s),s.connect(t.destination),i.start(0),i.stop(.001),setTimeout(()=>t.close(),100)}}catch{}if(window.speechSynthesis)try{const e=new SpeechSynthesisUtterance("");e.volume=0,window.speechSynthesis.speak(e),window.speechSynthesis.cancel()}catch{}this.audioUnlocked=!0}},_showIOSAudioPrompt(){return new Promise(e=>{if(sessionStorage.getItem("iosAudioPromptShown")){e();return}const t=document.createElement("div");t.id="iosAudioPrompt",t.innerHTML=`
                <div style="
                    position: fixed;
                    top: 0; left: 0; right: 0; bottom: 0;
                    background: rgba(0,0,0,0.8);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 99999;
                    backdrop-filter: blur(5px);
                ">
                    <div style="
                        background: var(--surface, #1e1e1e);
                        padding: 2rem;
                        border-radius: 1rem;
                        text-align: center;
                        max-width: 300px;
                        box-shadow: 0 10px 40px rgba(0,0,0,0.5);
                    ">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ”Š</div>
                        <h3 style="color: var(--text-main, #fff); margin-bottom: 0.5rem;">ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª</h3>
                        <p style="color: var(--text-secondary, #aaa); font-size: 0.9rem; margin-bottom: 1rem;">
                            Ø§Ø¶ØºØ· Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù†Ø·Ù‚ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ
                        </p>
                        <button id="iosAudioUnlockBtn" style="
                            background: var(--primary, #3b82f6);
                            color: white;
                            border: none;
                            padding: 0.75rem 2rem;
                            border-radius: 0.5rem;
                            font-size: 1rem;
                            cursor: pointer;
                        ">Ø§Ø¶ØºØ· Ù‡Ù†Ø§ â–¶ï¸</button>
                    </div>
                </div>
            `,document.body.appendChild(t);const i=document.getElementById("iosAudioUnlockBtn");i&&(i.onclick=()=>{this.unlockAudio(),sessionStorage.setItem("iosAudioPromptShown","true"),t.remove(),e()}),t.onclick=s=>{s.target!==t.firstElementChild&&(this.unlockAudio(),sessionStorage.setItem("iosAudioPromptShown","true"),t.remove(),e())}})},async speak(e,t="sv",i={}){if(!e||e.trim()==="")return;const s=e.replace(/['']/g,"'").trim();if(s===this.lastSpokenText&&this.isPlaying)return;this.lastSpokenText=s;const c=this._normalizeLang(t),d=window.ProgressManager;return typeof d<"u"&&d.trackTTS(s),this.stop(),this.isPlaying=!0,this.isIOS&&!this.audioUnlocked&&await this._showIOSAudioPrompt(),i.onStart&&i.onStart(),i.slow&&(i.speed=.45),this._speakWithProviders(s,c,i)},speakSwedish(e,t={}){return this.speak(e,"sv-SE",t)},speakArabic(e,t={}){return this.speak(e,"ar",t)},speakSlowly(e,t="sv"){return this.speak(e,t,{slow:!0})},async _speakWithProviders(e,t,i){const s=navigator.onLine,d=this.isIOS||i.slow?[{name:"Local TTS",fn:()=>this._playLocalTTS(e,t,i)},{name:"Google TTS",fn:()=>this._playGoogleTTS(e,t,i),requiresOnline:!0},{name:"VoiceRSS",fn:()=>this._playVoiceRSS(e,t,i),requiresOnline:!0}]:[{name:"Google TTS",fn:()=>this._playGoogleTTS(e,t,i),requiresOnline:!0},{name:"Local TTS",fn:()=>this._playLocalTTS(e,t,i)},{name:"VoiceRSS",fn:()=>this._playVoiceRSS(e,t,i),requiresOnline:!0}];for(let o=0;o<d.length;o++){const a=d[o];if(!(a.requiresOnline&&!s))try{await a.fn();return}catch(l){console.warn(`ğŸ”Š ${a.name} failed:`,l.message),o===d.length-1&&(this.isPlaying=!1,i.onError&&i.onError(l))}}},_playVoiceRSS(e,t,i={}){return new Promise((s,c)=>{const d="a28d3d026971413cba0c492136085fae",a={"sv-SE":"sv-se",sv:"sv-se","ar-SA":"ar-sa",ar:"ar-sa","en-US":"en-us",en:"en-us"}[t]||"sv-se";this.audio=f.createAudio();const l=`https://api.voicerss.org/?key=${d}&hl=${a}&src=${encodeURIComponent(e)}&c=MP3&f=44khz_16bit_stereo`;this.audio.src=l,this.audio.volume=i.volume||1;const r=i.speed||this.getSpeed();this.audio.oncanplay=()=>{try{this.audio.playbackRate=r}catch{}},this.audio.onended=()=>{this.isPlaying=!1,i.onEnd&&i.onEnd(),s()},this.audio.onerror=()=>{this.isPlaying=!1,c(new Error("VoiceRSS audio error"))};const n=setTimeout(()=>{this.audio&&(this.audio.readyState<2||this.audio.paused)&&(this.audio.pause(),c(new Error("VoiceRSS timeout")))},this.config.timeoutMs);this.audio.play().then(()=>clearTimeout(n)).catch(c)})},_playGoogleTTS(e,t,i={}){return new Promise((s,c)=>{this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=null),this.audio=f.createAudio();const d=t.substring(0,2),o=`https://translate.google.com/translate_tts?ie=UTF-8&tl=${d}&client=tw-ob&q=${encodeURIComponent(e)}`,a=`https://translate.google.com/translate_tts?ie=UTF-8&tl=${d}&client=gtx&q=${encodeURIComponent(e)}`,l=()=>{this.audio&&(this.audio.src=a,this.audio.onerror=()=>{this.isPlaying=!1,c(new Error("Google TTS failed"))},this.audio.play().catch(c))};this.audio.src=this.audioCache.get(o)||o,this.audio.volume=i.volume||1;const r=i.speed||this.getSpeed();this.audio.oncanplay=()=>{try{this.audio.playbackRate=r}catch{}},this.audio.onended=()=>{this.isPlaying=!1,i.onEnd&&i.onEnd(),s()},this.audio.onerror=l,this.timeoutId=setTimeout(()=>{this.audio&&(this.audio.readyState<2||this.audio.paused)&&(this.audio.pause(),c(new Error("Google TTS timeout")))},this.config.timeoutMs),this.audio.play().then(()=>{if(!this.audioCache.has(o)){if(this.audioCache.size>=this.config.maxCacheSize){const n=this.audioCache.keys().next().value;n&&this.audioCache.delete(n)}this.audioCache.set(o,o)}}).catch(l)})},_playLocalTTS(e,t,i={}){return new Promise((s,c)=>{if(!window.speechSynthesis){c(new Error("Local TTS not supported"));return}window.speechSynthesis.cancel();const d=this.isIOS?250:50;setTimeout(()=>{let o=this._prepareTextForSpeech(e,t);const a=new SpeechSynthesisUtterance(o);a.lang=t;const l=i.speed||this.getSpeed();this.isIOS?a.rate=Math.max(.6,l*.75):a.rate=l*.9;const r=()=>{const n=window.speechSynthesis.getVoices(),h=t.substring(0,2);let p=null;const u=localStorage.getItem("ttsVoicePreference")||"natural";if(h==="sv"){const m=u==="male"?["Oskar","Svenska"]:u==="female"?["Alva","Klara","Maja"]:["Alva","Klara","Oskar","Svenska"];for(const g of m)if(p=n.find(S=>S.name.includes(g)&&S.lang.includes("sv"))||null,p)break;p||(p=n.find(g=>g.lang.includes("sv"))||null)}else p=this._findBestVoice(h);p&&(a.voice=p),a.onboundary=m=>{if(m.name==="word"){const S={word:o.substring(m.charIndex,m.charIndex+m.charLength),charIndex:m.charIndex,charLength:m.charLength,text:o};window.dispatchEvent(new CustomEvent("tts-boundary",{detail:S}))}},window.speechSynthesis.speak(a)};a.onstart=()=>{window.dispatchEvent(new CustomEvent("tts-start",{detail:{text:o}}))},a.onend=()=>{this.isPlaying=!1,window.dispatchEvent(new CustomEvent("tts-end")),i.onEnd&&i.onEnd(),s()},a.onerror=n=>{this.isPlaying=!1,window.dispatchEvent(new CustomEvent("tts-error",{detail:n})),n.error!=="interrupted"?this.isIOS?s():c(n):s()},window.speechSynthesis.getVoices().length===0?(window.speechSynthesis.onvoiceschanged=()=>{r(),window.speechSynthesis.onvoiceschanged=null},setTimeout(r,500)):r()},d)})},_prepareTextForSpeech(e,t){let i=e;return t.startsWith("sv")&&(i=i.replace(/,/g,", ").replace(/\./g,". "),i=i.replace(/(\d+)/g," $1 "),this.isIOS&&!i.match(/[.!?]$/)&&(i=i+".")),t.startsWith("ar")&&(i=i.replace(/ØŒ/g,", ")),i.trim()},_findBestVoice(e){if(e==="sv"&&this.cachedSwedishVoice)return this.cachedSwedishVoice;const t=this.cachedVoices[e]||[];if(!t.length)return null;const i=["Neural","Neural2","WaveNet","Premium","Enhanced"],s=["Natural","Siri","Google","Microsoft"],c={sv:["Alva","Klara","Maja","Oskar","Astrid","Sofie","Erik"],ar:["Maged","Majed","Tarik","Laila","Mariam","Zeina","Hoda"],en:["Samantha","Karen","Daniel","Alex","Moira","Tessa"]},d=["Compact","eSpeak","Android","espeak","MBROLA"],o=localStorage.getItem("ttsVoicePreference")||"natural",a=r=>{let n=0;const h=r.name;return d.some(u=>h.toLowerCase().includes(u.toLowerCase()))?-100:(i.some(u=>h.includes(u))&&(n+=100),s.some(u=>h.includes(u))&&(n+=50),(c[e]||[]).some(u=>h.includes(u))&&(n+=30),r.localService&&(n+=10),o==="male"?["Daniel","Oskar","Erik","Maged","Alex"].some(u=>h.includes(u))&&(n+=20):o==="female"&&["Alva","Klara","Maja","Samantha","Laila"].some(u=>h.includes(u))&&(n+=20),n)},l=t.map(r=>({voice:r,score:a(r)})).filter(r=>r.score>-100).sort((r,n)=>n.score-r.score);return l.length>0?(console.log(`ğŸ”Š Best voice for ${e}: ${l[0].voice.name} (score: ${l[0].score})`),l[0].voice):t[0]},_normalizeLang(e){return{sv:"sv-SE",ar:"ar-SA",en:"en-US",de:"de-DE",fr:"fr-FR"}[e]||e},stop(){if(this.audio)try{this.audio.pause(),this.audio.currentTime=0}catch{}if(f.cleanup(),window.speechSynthesis)try{window.speechSynthesis.cancel()}catch{}this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=null),this.isPlaying=!1,window.dispatchEvent(new CustomEvent("tts-stop"))}};function v(e,t="sv"){return w.speak(e,t)}function y(e){return w.speak(e,"sv-SE")}function A(e){return w.speak(e,"ar")}typeof window<"u"&&(window.TTSManager=w,window.speakText=v,window.speakSwedish=y,window.speakArabic=A,document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>w.init()):w.init());export{w as T,y as s};
