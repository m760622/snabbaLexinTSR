import{A as d}from"./config-8gd_ljfe.js";const h={DB_NAME:d.DB_NAME,DB_VERSION:d.DB_VERSION,STORE_NAME:"words",META_STORE:"meta",NOTES_STORE:"notes",TRAINING_STORE:"training",db:null,isReady:!1,async init(){return this.db?!0:new Promise((t,r)=>{const o=indexedDB.open(this.DB_NAME,this.DB_VERSION);o.onerror=e=>{console.error("[DB] Error opening database:",e.target.error),r(e.target.error)},o.onsuccess=e=>{this.db=e.target.result,this.isReady=!0,console.log("[DB] Database opened successfully"),t(!0)},o.onupgradeneeded=e=>{const s=e.target.result;if(!s.objectStoreNames.contains(this.STORE_NAME)){const n=s.createObjectStore(this.STORE_NAME,{keyPath:"id"});n.createIndex("swedish","swe",{unique:!1}),n.createIndex("arabic","arb",{unique:!1}),n.createIndex("type","type",{unique:!1}),console.log("[DB] Words store created")}if(s.objectStoreNames.contains(this.META_STORE)||(s.createObjectStore(this.META_STORE,{keyPath:"key"}),console.log("[DB] Meta store created")),s.objectStoreNames.contains(this.NOTES_STORE)||(s.createObjectStore(this.NOTES_STORE,{keyPath:"id"}),console.log("[DB] Notes store created")),!s.objectStoreNames.contains(this.TRAINING_STORE))s.createObjectStore(this.TRAINING_STORE,{keyPath:"id"}).createIndex("addedAt","addedAt",{unique:!1}),console.log("[DB] Training store created with addedAt index");else{const n=e.target.transaction;if(n){const i=n.objectStore(this.TRAINING_STORE);i.indexNames.contains("addedAt")||(i.createIndex("addedAt","addedAt",{unique:!1}),console.log("[DB] Added addedAt index to existing training store"))}}}})},async getDataVersion(){return this.db||await this.init(),this.db?new Promise(t=>{try{const e=this.db.transaction([this.META_STORE],"readonly").objectStore(this.META_STORE).get("dataVersion");e.onsuccess=()=>{var s;t(((s=e.result)==null?void 0:s.value)||null)},e.onerror=()=>t(null)}catch{t(null)}}):null},async setDataVersion(t){return this.db||await this.init(),this.db?new Promise((r,o)=>{const e=this.db.transaction([this.META_STORE],"readwrite");e.objectStore(this.META_STORE).put({key:"dataVersion",value:t}),e.oncomplete=()=>r(!0),e.onerror=n=>o(n)}):!1},async getWordCount(){return this.db||await this.init(),this.db?new Promise(t=>{try{const e=this.db.transaction([this.STORE_NAME],"readonly").objectStore(this.STORE_NAME).count();e.onsuccess=()=>t(e.result),e.onerror=()=>t(0)}catch{t(0)}}):0},async saveWords(t,r=null){this.db||await this.init();const o=1e3,e=Math.ceil(t.length/o);console.log(`[DB] Saving ${t.length} words in ${e} batches...`);for(let s=0;s<e;s++){const n=s*o,i=Math.min(n+o,t.length),c=t.slice(n,i);if(await this._saveBatch(c),r){const l=Math.round((s+1)/e*100);r(l)}}return console.log("[DB] All words saved successfully"),!0},async _saveBatch(t){return this.db?new Promise((r,o)=>{const e=this.db.transaction([this.STORE_NAME],"readwrite"),s=e.objectStore(this.STORE_NAME);t.forEach(n=>{const i={id:n[d.COLUMNS.ID],type:n[d.COLUMNS.TYPE],swe:n[d.COLUMNS.SWEDISH],arb:n[d.COLUMNS.ARABIC],arbExt:n[d.COLUMNS.ARABIC_EXT],sweDef:n[d.COLUMNS.DEFINITION],forms:n[d.COLUMNS.FORMS],sweEx:n[d.COLUMNS.EXAMPLE_SWE],arbEx:n[d.COLUMNS.EXAMPLE_ARB],idiomSwe:n[d.COLUMNS.IDIOM_SWE],idiomArb:n[d.COLUMNS.IDIOM_ARB],raw:n};s.put(i)}),e.oncomplete=()=>r(!0),e.onerror=n=>o(n)}):!1},async getAllWords(t=null){return this.db||await this.init(),this.db?new Promise((r,o)=>{const n=this.db.transaction([this.STORE_NAME],"readonly").objectStore(this.STORE_NAME).getAll();n.onsuccess=()=>{const i=n.result.map(c=>c.raw);t&&t(100),console.log(`[DB] Retrieved ${i.length} words from cache`),r(i)},n.onerror=i=>{console.error("[DB] Error getting words:",i),o(i)}}):[]},async hasCachedData(){return await this.getWordCount()>0},async clearCache(){return this.db||await this.init(),this.db?new Promise((t,r)=>{const o=this.db.transaction([this.STORE_NAME,this.META_STORE],"readwrite");o.objectStore(this.STORE_NAME).clear(),o.objectStore(this.META_STORE).clear(),o.oncomplete=()=>{console.log("[DB] Cache cleared"),t(!0)},o.onerror=e=>r(e)}):!1},async getWordById(t){return this.db||await this.init(),this.db?new Promise(r=>{try{const s=this.db.transaction([this.STORE_NAME],"readonly").objectStore(this.STORE_NAME).get(t);s.onsuccess=()=>{s.result&&s.result.raw?r(s.result.raw):r(null)},s.onerror=()=>r(null)}catch(o){console.error("[DB] getWordById error:",o),r(null)}}):null},async getRandomWord(){return this.db||await this.init(),this.db?new Promise(async t=>{try{const r=await this.getWordCount();if(r===0){t(null);return}const o=Math.floor(Math.random()*r),n=this.db.transaction([this.STORE_NAME],"readonly").objectStore(this.STORE_NAME).openCursor();let i=!1;n.onsuccess=c=>{const l=c.target.result;if(!l){t(null);return}if(!i&&o>0)i=!0,l.advance(o);else{const a=l.value.raw||l.value;a&&(a.swedish||a.swe)?(!a.swedish&&a.swe&&(a.swedish=a.swe),!a.arabic&&a.arb&&(a.arabic=a.arb),t(a)):t(null)}},n.onerror=()=>t(null)}catch(r){console.error("[DB] getRandomWord error:",r),t(null)}}):null},async saveWord(t){return this.db||await this.init(),this.db?new Promise((r,o)=>{const e=this.db.transaction([this.STORE_NAME],"readwrite");e.objectStore(this.STORE_NAME).put(t),e.oncomplete=()=>r(!0),e.onerror=n=>o(n)}):!1},async deleteWord(t){return this.db||await this.init(),this.db?new Promise((r,o)=>{const e=this.db.transaction([this.STORE_NAME],"readwrite");e.objectStore(this.STORE_NAME).delete(t),e.oncomplete=()=>r(!0),e.onerror=n=>o(n)}):!1},async getNote(t){return this.db||await this.init(),this.db?new Promise(r=>{try{const s=this.db.transaction([this.NOTES_STORE],"readonly").objectStore(this.NOTES_STORE).get(t);s.onsuccess=()=>{var n;r(((n=s.result)==null?void 0:n.text)||null)},s.onerror=()=>r(null)}catch{r(null)}}):null},async saveNote(t,r){return this.db||await this.init(),this.db?new Promise((o,e)=>{const s=this.db.transaction([this.NOTES_STORE],"readwrite");s.objectStore(this.NOTES_STORE).put({id:t,text:r,updatedAt:Date.now()}),s.oncomplete=()=>o(!0),s.onerror=i=>e(i)}):!1},async updateTrainingStatus(t,r){if(!t){console.warn("[DB] updateTrainingStatus called with empty wordId");return}if(this.db||await this.init(),!!this.db)return new Promise(o=>{const e=this.db.transaction([this.TRAINING_STORE],"readwrite"),s=e.objectStore(this.TRAINING_STORE);r?s.put({id:t,addedAt:Date.now()}):s.delete(t),e.oncomplete=()=>{console.log(`[DB] Training status updated for ${t}: ${r}`),o()},e.onerror=n=>{console.error("[DB] Error updating training status:",n),o()}})},async ensureCustomWord(t){if(this.db||await this.init(),!!this.db)return new Promise((r,o)=>{const e=this.db.transaction([this.STORE_NAME],"readwrite"),s=e.objectStore(this.STORE_NAME),n=s.get(t.id);n.onsuccess=()=>{n.result||(s.put(t),console.log(`[DB] Custom word ${t.id} created`))},e.oncomplete=()=>r(),e.onerror=i=>o(i)})},async getTrainingWords(){return this.db||await this.init(),this.db?new Promise((t,r)=>{const o=this.db.transaction([this.TRAINING_STORE,this.STORE_NAME],"readonly"),e=o.objectStore(this.TRAINING_STORE),s=o.objectStore(this.STORE_NAME),n=e.index("addedAt").getAll();n.onsuccess=async()=>{const i=n.result;if(i.length===0){console.log("[DB] Found 0 words for training"),t([]);return}const c=[];let l=0;for(const a of i){const u=s.get(a.id);u.onsuccess=()=>{u.result?c.push(u.result.raw||u.result):c.push({id:a.id}),l++,l===i.length&&(console.log(`[DB] Found ${c.length} words for training`),t(c))},u.onerror=()=>{l++,l===i.length&&(console.log(`[DB] Found ${c.length} words for training`),t(c))}}},n.onerror=i=>r(i)}):[]},async isWordMarkedForTraining(t){return this.db||await this.init(),this.db?new Promise(r=>{const s=this.db.transaction([this.TRAINING_STORE],"readonly").objectStore(this.TRAINING_STORE).get(t);s.onsuccess=()=>{r(!!s.result)},s.onerror=()=>r(!1)}):!1},async updateReviewData(t,r){if(t&&(this.db||await this.init(),!!this.db))return new Promise((o,e)=>{const s=this.db.transaction([this.TRAINING_STORE],"readwrite"),n=s.objectStore(this.TRAINING_STORE),i=n.get(t);i.onsuccess=()=>{const l={...i.result||{id:t,addedAt:Date.now()},...r};n.put(l)},s.oncomplete=()=>{console.log(`[DB] Review data updated for ${t}`),o()},s.onerror=c=>e(c)})},async getTrainingWordsDue(){const t=await this.getTrainingWords(),r=Date.now();return this.db||await this.init(),this.db?new Promise(o=>{const n=this.db.transaction([this.TRAINING_STORE],"readonly").objectStore(this.TRAINING_STORE).getAll();n.onsuccess=()=>{const i=n.result,c=new Map(i.map(a=>[a.id,a])),l=t.filter(a=>{const u=Array.isArray(a)?a[0]:a.id,S=c.get(u);return S!=null&&S.nextReview?S.nextReview<=r:!0});l.sort((a,u)=>{const S=Array.isArray(a)?a[0]:a.id,T=Array.isArray(u)?u[0]:u.id,f=c.get(S),E=c.get(T);return f!=null&&f.nextReview?E!=null&&E.nextReview?f.nextReview-E.nextReview:1:-1}),console.log(`[DB] Found ${l.length} words due for review`),o(l)},n.onerror=()=>o(t)}):t},async getReviewData(t){return this.db||await this.init(),this.db?new Promise(r=>{const s=this.db.transaction([this.TRAINING_STORE],"readonly").objectStore(this.TRAINING_STORE).get(t);s.onsuccess=()=>r(s.result||null),s.onerror=()=>r(null)}):null},async saveTrainingSession(t){const r="training_sessions",o=JSON.parse(localStorage.getItem(r)||"[]");o.push(t);const e=o.slice(-30);localStorage.setItem(r,JSON.stringify(e))},getTrainingSessions(){return JSON.parse(localStorage.getItem("training_sessions")||"[]")},async getTrainingCount(){return this.db||await this.init(),this.db?new Promise(t=>{const e=this.db.transaction([this.TRAINING_STORE],"readonly").objectStore(this.TRAINING_STORE).count();e.onsuccess=()=>t(e.result),e.onerror=()=>t(0)}):0}},w={async loadDictionary(t=null,r=null){try{await h.init();const o=await h.getDataVersion();if(await h.hasCachedData()&&o===d.DATA_VERSION)return r&&r("Laddar från cache... / جاري التحميل من الذاكرة..."),console.log("[DataLoader] Using cached data (version:",o,")"),await h.getAllWords(t);r&&r("Laddar ordbok... / جاري تحميل القاموس..."),console.log("[DataLoader] Loading fresh data from data.js");let s=window.dictionaryData;if(typeof s>"u"||!s.length){r&&r("Laddar datafil... / جاري تحميل ملف البيانات..."),console.log("[DataLoader] Global data missing, fetching from",d.DATA_PATH.root);try{const n=await fetch(d.DATA_PATH.root);if(!n.ok)throw new Error(`HTTP ${n.status}`);s=await n.json(),window.dictionaryData=s}catch(n){throw console.error("[DataLoader] Fetch failed:",n),new Error("dictionaryData could not be loaded")}}return r&&r("Sparar i cache... / جاري الحفظ..."),await h.saveWords(s,t),await h.setDataVersion(d.DATA_VERSION),console.log("[DataLoader] Data cached successfully"),s}catch(o){console.error("[DataLoader] Error:",o);const e=window.dictionaryData;if(typeof e<"u")return e;throw o}},async refreshCache(t=null){return await h.clearCache(),this.loadDictionary(t)}};typeof window<"u"&&(window.DictionaryDB=h,window.DataLoader=w,window.DATA_VERSION=d.DATA_VERSION);export{w as DataLoader,h as DictionaryDB};
